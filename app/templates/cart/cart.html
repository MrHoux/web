{% extends "base.html" %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="fw-bold mb-4">Shopping Cart</h2>

    <div class="row g-5" id="cart-container">
        <!-- Cart Items -->
        <div class="col-lg-8">
            <div id="cart-items-list">
                <!-- Items will be loaded here via AJAX -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 90px;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">Order Summary</h5>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-secondary">Subtotal</span>
                        <span class="fw-bold" id="cart-subtotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-secondary">Shipping</span>
                        <span class="text-success">Free</span>
                    </div>
                    <hr class="my-4">
                    <div class="d-flex justify-content-between mb-4">
                        <span class="fw-bold fs-5">Total</span>
                        <span class="fw-bold fs-5 text-primary" id="cart-total">$0.00</span>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg shadow-sm" id="checkout-btn" disabled>
                        Proceed to Checkout
                    </button>
                    <a href="{{ url_for('products.product_list') }}" class="btn btn-link w-100 mt-2 text-decoration-none text-secondary">
                        Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Empty Cart Template (Hidden) -->
    <div id="empty-cart-template" class="d-none">
        <div class="text-center py-5 bg-white rounded-3 shadow-sm">
            <div class="mb-4 text-secondary opacity-50">
                <i class="bi bi-cart-x display-1"></i>
            </div>
            <h3 class="fw-bold mb-3">Your cart is empty</h3>
            <p class="text-secondary mb-4">Start with a category and add your first items.</p>
            <a href="{{ url_for('products.product_list') }}" class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm">Browse NovaMart</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { api } from "{{ url_for('static', filename='js/api.js') }}";
    import { showToast, formatCurrency, updateCartBadge } from "{{ url_for('static', filename='js/utils.js') }}";

    const cartList = document.getElementById('cart-items-list');
    const subtotalEl = document.getElementById('cart-subtotal');
    const totalEl = document.getElementById('cart-total');
    const checkoutBtn = document.getElementById('checkout-btn');
    const emptyTemplate = document.getElementById('empty-cart-template');

    document.addEventListener('DOMContentLoaded', loadCart);

    async function loadCart() {
        try {
            const cart = await api.get("{{ url_for('cart.get_cart') }}");
            renderCart(cart);
        } catch (error) {
            showToast('Failed to load cart', 'error');
        }
    }

    function renderCart(cart) {
        if (!cart.items || cart.items.length === 0) {
            cartList.innerHTML = emptyTemplate.innerHTML;
            checkoutBtn.disabled = true;
            updateSummary(0);
            updateCartBadge(0);
            return;
        }

        const placeholder = "{{ url_for('static', filename='images/placeholder.png') }}";
        let totalAmount = 0;
        let html = '';

        cart.items.forEach(item => {
            const itemTotal = item.product.price * item.quantity;
            totalAmount += itemTotal;

            html += `
                <div class="card border-0 shadow-sm mb-3 cart-item" data-product-id="${item.product_id}">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            <img src="${item.product.image_url || placeholder}" class="rounded me-3" style="width: 80px; height: 80px; object-fit: contain;" alt="${item.product.title || 'Product'}">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between mb-2">
                                    <h6 class="fw-bold mb-0">
                                        <a href="/p/${item.product_id}" class="text-decoration-none text-dark">${item.product.title}</a>
                                    </h6>
                                    <button class="btn btn-link text-danger p-0 ms-2 remove-btn" aria-label="Remove item">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-primary fw-bold">${formatCurrency(item.product.price)}</span>
                                    <div class="input-group input-group-sm" style="width: 120px;">
                                        <button class="btn btn-outline-secondary qty-btn" data-action="decrease" aria-label="Decrease quantity">-</button>
                                        <input type="number" class="form-control text-center" value="${item.quantity}" min="1" max="${item.product.stock}" readonly aria-label="Quantity">
                                        <button class="btn btn-outline-secondary qty-btn" data-action="increase" aria-label="Increase quantity" ${item.quantity >= item.product.stock ? 'disabled' : ''}>+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        cartList.innerHTML = html;
        updateSummary(totalAmount);
        updateCartBadge(cart.total_items);
        checkoutBtn.disabled = false;
        
        // Setup event listeners
        setupCartListeners();
    }

    function updateSummary(total) {
        const formatted = formatCurrency(total);
        subtotalEl.textContent = formatted;
        totalEl.textContent = formatted;
    }

    function setupCartListeners() {
        // Quantity update
        document.querySelectorAll('.qty-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const itemEl = btn.closest('.cart-item');
                const productId = itemEl.dataset.productId;
                const input = itemEl.querySelector('input');
                let newQty = parseInt(input.value);

                if (btn.dataset.action === 'increase') newQty++;
                else newQty--;

                if (newQty < 1) return;

                try {
                    await api.patch(`/api/cart/items/${productId}`, { quantity: newQty }, { showLoading: true });
                    loadCart(); // Reload to refresh totals and stock limits
                } catch (error) {
                    showToast(error.message, 'error');
                }
            });
        });

        // Remove item
        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const itemEl = btn.closest('.cart-item');
                const productId = itemEl.dataset.productId;

                try {
                    await api.delete(`/api/cart/items/${productId}`, { showLoading: true });
                    loadCart();
                    showToast('Item removed', 'info');
                } catch (error) {
                    showToast(error.message, 'error');
                }
            });
        });

        // Checkout
        checkoutBtn.onclick = () => {
            window.location.href = "{{ url_for('orders.checkout_page') }}";
        };
    }
</script>
{% endblock %}

